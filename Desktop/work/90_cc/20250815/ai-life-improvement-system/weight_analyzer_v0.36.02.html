<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“é‡ãƒ‡ãƒ¼ã‚¿æ©Ÿæ¢°å­¦ç¿’åˆ†æã‚·ã‚¹ãƒ†ãƒ  v0.36.03</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            font-weight: 300; 
        }
        .header p { 
            font-size: 1.1em; 
            opacity: 0.9; 
        }
        .content { 
            padding: 30px; 
        }
        .section { 
            margin: 30px 0; 
            padding: 25px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            transition: all 0.3s ease;
        }
        .section:hover { 
            border-color: #667eea; 
            box-shadow: 0 5px 15px rgba(102,126,234,0.1); 
        }
        .section h2 { 
            color: #333; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #eee; 
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 1em; 
            margin: 5px; 
            transition: all 0.3s ease;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102,126,234,0.3); 
        }
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            font-weight: bold; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .stat-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .stat-value { 
            font-size: 2em; 
            font-weight: bold; 
            color: #667eea; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 5px; 
        }
        .chart-container { 
            margin: 20px 0; 
            text-align: center; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä½“é‡ãƒ‡ãƒ¼ã‚¿æ©Ÿæ¢°å­¦ç¿’åˆ†æã‚·ã‚¹ãƒ†ãƒ  v0.36.03</h1>
            <p>æ™‚é–“ã‚¹ã‚±ãƒ¼ãƒ«é¸æŠã¨ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ©Ÿèƒ½è¿½åŠ ç‰ˆ</p>
        </div>
        
        <div class="content">
            <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>èªè¨¼</h2>
                <div id="authStatus" class="status info">èªè¨¼ãŒå¿…è¦ã§ã™</div>
                <button id="loginBtn" class="btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="logoutBtn" class="btn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                <div id="userInfo" style="margin-top: 15px; display: none;">
                    <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong> <span id="userName"></span>
                </div>
            </div>
            
            <!-- ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»åˆ†æ</h2>
                <button id="fetchDataBtn" class="btn" disabled>ä½“é‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                <button id="analyzeBtn" class="btn" disabled>æ©Ÿæ¢°å­¦ç¿’åˆ†æå®Ÿè¡Œ</button>
                <div id="dataStatus" class="status info">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</div>
                <div id="errorAlert" class="status error" style="display: none;"></div>
            </div>
            
            <!-- åŸºæœ¬çµ±è¨ˆ -->
            <div class="section" id="statisticsSection" style="display: none;">
                <h2>åŸºæœ¬çµ±è¨ˆ</h2>
                <div class="stat-grid" id="statGrid"></div>
            </div>
            
            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
            <div class="section" id="chartsSection" style="display: none;">
                <h2>ã‚°ãƒ©ãƒ•è¡¨ç¤º</h2>
                <div style="margin-bottom: 20px; text-align: center;">
                    <button id="scaleHourBtn" class="btn">æ™‚é–“åˆ¥</button>
                    <button id="scaleDayBtn" class="btn" style="background: #444;">æ—¥åˆ¥ (æœ€å¤§/æœ€å°/å¹³å‡)</button>
                    <button id="scaleWeekBtn" class="btn">é€±åˆ¥ (æœ€å¤§/æœ€å°/å¹³å‡)</button>
                    <button id="scaleMonthBtn" class="btn">æœˆåˆ¥ (æœ€å¤§/æœ€å°/å¹³å‡)</button>
                </div>
                <div class="chart-container">
                    <canvas id="weightChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- æ©Ÿæ¢°å­¦ç¿’çµæœ -->
            <div class="section" id="mlSection" style="display: none;">
                <h2>æ©Ÿæ¢°å­¦ç¿’åˆ†æçµæœ</h2>
                <div id="mlResults"></div>
            </div>
            
            <!-- AIæ”¹å–„ææ¡ˆ -->
            <div class="section" id="insightsSection" style="display: none;">
                <h2>AIæ”¹å–„ææ¡ˆ</h2>
                <div id="insights"></div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase v8 SDK - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        console.log('v0.36.03: æ™‚é–“ã‚¹ã‚±ãƒ¼ãƒ«é¸æŠã¨ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ©Ÿèƒ½è¿½åŠ ç‰ˆé–‹å§‹');
        
        // Firebaseè¨­å®šï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };
        
        // FirebaseåˆæœŸåŒ–ï¼ˆv8æ–¹å¼ï¼‰
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        console.log('v0.36-debug: Firebase v8 åˆæœŸåŒ–å®Œäº†');
        
        let userData = null;
        let weightData = null;
        let weightChart = null;
        let weeklyChart = null;
        let currentScale = 'day';
        
        // DOMè¦ç´ 
        const authStatus = document.getElementById('authStatus');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const dataStatus = document.getElementById('dataStatus');
        const errorAlert = document.getElementById('errorAlert');
        const scaleHourBtn = document.getElementById('scaleHourBtn');
        const scaleDayBtn = document.getElementById('scaleDayBtn');
        const scaleWeekBtn = document.getElementById('scaleWeekBtn');
        const scaleMonthBtn = document.getElementById('scaleMonthBtn');
        
        // èªè¨¼çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged((user) => {
            console.log('v0.36-debug: èªè¨¼çŠ¶æ…‹å¤‰æ›´', user ? 'èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼');
            if (user) {
                userData = user;
                authStatus.innerHTML = '<span class="success">èªè¨¼æ¸ˆã¿</span>';
                authStatus.className = 'status success';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userInfo.style.display = 'block';
                userName.textContent = user.displayName || user.email;
                fetchDataBtn.disabled = false;
                dataStatus.innerHTML = '<span class="info">ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æº–å‚™ãŒã§ãã¾ã—ãŸ</span>';
                dataStatus.className = 'status info';
            } else {
                userData = null;
                authStatus.innerHTML = '<span class="info">èªè¨¼ãŒå¿…è¦ã§ã™</span>';
                authStatus.className = 'status info';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
                fetchDataBtn.disabled = true;
                analyzeBtn.disabled = true;
                dataStatus.innerHTML = '<span class="info">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</span>';
                dataStatus.className = 'status info';
                hideAllSections();
            }
        });
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
        loginBtn.addEventListener('click', async () => {
            try {
                console.log('v0.36-debug: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œé–‹å§‹');
                authStatus.innerHTML = '<span class="info">èªè¨¼ä¸­...</span>';
                authStatus.className = 'status info';
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                const result = await auth.signInWithPopup(provider);
                console.log('v0.36-debug: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', result.user.email);
            } catch (error) {
                console.error('v0.36-debug: èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                authStatus.innerHTML = '<span class="error">èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                authStatus.className = 'status error';
            }
        });
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
        logoutBtn.addEventListener('click', async () => {
            try {
                console.log('v0.36-debug: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ');
                await auth.signOut();
                hideAllSections();
            } catch (error) {
                console.error('v0.36-debug: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        });
        
        // ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒœã‚¿ãƒ³ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ãƒ‘ã‚¹ï¼‰
        fetchDataBtn.addEventListener('click', async () => {
            if (!userData) {
                dataStatus.innerHTML = '<span class="error">èªè¨¼ãŒå¿…è¦ã§ã™</span>';
                dataStatus.className = 'status error';
                return;
            }
            
            try {
                console.log('v0.36-debug: ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userData.uid);
                dataStatus.innerHTML = '<span class="info">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</span>';
                dataStatus.className = 'status info';
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ãƒ‘ã‚¹: users/${currentUser.uid}/weights
                const userRef = database.ref(`users/${userData.uid}/weights`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    weightData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ', weightData.length, 'ä»¶');
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: å…¨ãƒ‡ãƒ¼ã‚¿:');
                    weightData.forEach((d, i) => console.log(`${i}: ${d.date} - ${d.weight}kg`));
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œå‡º
                    const errorData = weightData.filter(d => 
                        d.weight === undefined || 
                        d.weight === null || 
                        d.weight === '' || 
                        isNaN(parseFloat(d.weight))
                    );
                    
                    if (errorData.length > 0) {
                        console.warn('âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹:', errorData.length, 'ä»¶');
                        errorData.forEach((d, i) => console.warn(`ã‚¨ãƒ©ãƒ¼${i}: ${d.date} - ${d.weight} (ç„¡åŠ¹ãªä½“é‡å€¤)`));
                        
                        errorAlert.innerHTML = `<strong>âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œå‡º:</strong> ${errorData.length}ä»¶ã®ç„¡åŠ¹ãªä½“é‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã‚°ãƒ©ãƒ•ã§ã¯é™¤å¤–ã•ã‚Œã¾ã™ã€‚`;
                        errorAlert.style.display = 'block';
                    } else {
                        errorAlert.style.display = 'none';
                    }
                    
                    // æ—¥ä»˜é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const allDates = weightData.map(d => d.date);
                    const uniqueDates = [...new Set(allDates)];
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: é‡è¤‡ãƒã‚§ãƒƒã‚¯:');
                    console.log(`ç·æ•°: ${allDates.length}, ä¸€æ„æ•°: ${uniqueDates.length}`);
                    if (allDates.length !== uniqueDates.length) {
                        console.error('ğŸš¨ å®Ÿãƒ‡ãƒ¼ã‚¿ã«æ—¥ä»˜é‡è¤‡ç™ºè¦‹ï¼');
                        const duplicates = allDates.filter((date, index) => allDates.indexOf(date) !== index);
                        console.error('é‡è¤‡æ—¥ä»˜:', [...new Set(duplicates)]);
                        
                        // é‡è¤‡æ—¥ä»˜ã®è©³ç´°
                        [...new Set(duplicates)].forEach(dupDate => {
                            const sameDateRecords = weightData.filter(d => d.date === dupDate);
                            console.error(`${dupDate} ã®è¨˜éŒ²:`, sameDateRecords);
                        });
                    }
                    
                    dataStatus.innerHTML = `<span class="success">${weightData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ</span>`;
                    dataStatus.className = 'status success';
                    
                    displayBasicStatistics();
                    displayCharts();
                    analyzeBtn.disabled = false;
                    
                } else {
                    console.log('v0.36-debug: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    dataStatus.innerHTML = '<span class="error">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½“é‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
                    dataStatus.className = 'status error';
                }
                
            } catch (error) {
                console.error('v0.36-debug: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                dataStatus.innerHTML = `<span class="error">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</span>`;
                dataStatus.className = 'status error';
            }
        });
        
        
        // ã‚¹ã‚±ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        scaleHourBtn.addEventListener('click', () => {
            currentScale = 'hour';
            updateScaleButtons();
            if (weightData) displayCharts();
        });
        
        scaleDayBtn.addEventListener('click', () => {
            currentScale = 'day';
            updateScaleButtons();
            if (weightData) displayCharts();
        });
        
        scaleWeekBtn.addEventListener('click', () => {
            currentScale = 'week';
            updateScaleButtons();
            if (weightData) displayCharts();
        });
        
        scaleMonthBtn.addEventListener('click', () => {
            currentScale = 'month';
            updateScaleButtons();
            if (weightData) displayCharts();
        });
        
        // ã‚¹ã‚±ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
        function updateScaleButtons() {
            [scaleHourBtn, scaleDayBtn, scaleWeekBtn, scaleMonthBtn].forEach(btn => {
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            });
            
            const activeBtn = {
                'hour': scaleHourBtn,
                'day': scaleDayBtn,
                'week': scaleWeekBtn,
                'month': scaleMonthBtn
            }[currentScale];
            
            if (activeBtn) {
                activeBtn.style.background = '#444';
            }
        }
        
        // æ©Ÿæ¢°å­¦ç¿’åˆ†æãƒœã‚¿ãƒ³
        analyzeBtn.addEventListener('click', async () => {
            if (!weightData || weightData.length < 5) {
                document.getElementById('mlResults').innerHTML = '<span class="error">åˆ†æã«ã¯æœ€ä½5ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™</span>';
                document.getElementById('mlSection').style.display = 'block';
                return;
            }
            
            try {
                console.log('v0.36-debug: æ©Ÿæ¢°å­¦ç¿’åˆ†æé–‹å§‹');
                const weights = weightData.map(d => parseFloat(d.weight)).filter(w => !isNaN(w));
                const trend = calculateTrend(weights);
                const insights = generateInsights(weightData, trend);
                
                document.getElementById('mlResults').innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h4>ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h4>
                        <p><strong>ä½“é‡å¤‰åŒ–å‚¾å‘:</strong> ${trend.direction}</p>
                        <p><strong>å¤‰åŒ–ç‡:</strong> ${trend.rate.toFixed(3)}kg/æ—¥</p>
                        <p><strong>äºˆæ¸¬ç²¾åº¦:</strong> ${trend.accuracy}%</p>
                        
                        <h4>7æ—¥å¾Œäºˆæ¸¬</h4>
                        <p><strong>äºˆæ¸¬ä½“é‡:</strong> ${trend.prediction.toFixed(1)}kg</p>
                        <p><strong>å¤‰åŒ–é‡:</strong> ${trend.change > 0 ? '+' : ''}${trend.change.toFixed(1)}kg</p>
                    </div>
                `;
                
                document.getElementById('insights').innerHTML = `
                    <h3>AIæ”¹å–„ææ¡ˆ</h3>
                    <ul style="list-style: none;">
                        ${insights.map(insight => `<li style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #ffc107;">${insight}</li>`).join('')}
                    </ul>
                `;
                
                document.getElementById('mlSection').style.display = 'block';
                document.getElementById('insightsSection').style.display = 'block';
                
                console.log('v0.36-debug: æ©Ÿæ¢°å­¦ç¿’åˆ†æå®Œäº†');
                
            } catch (error) {
                console.error('v0.36-debug: åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('mlResults').innerHTML = '<span class="error">åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                document.getElementById('mlSection').style.display = 'block';
            }
        });
        
        // åŸºæœ¬çµ±è¨ˆè¡¨ç¤º
        function displayBasicStatistics() {
            if (!weightData || weightData.length === 0) return;
            
            const weights = weightData.map(d => parseFloat(d.weight)).filter(w => !isNaN(w));
            if (weights.length === 0) return;
            
            const avgWeight = weights.reduce((a, b) => a + b, 0) / weights.length;
            const maxWeight = Math.max(...weights);
            const minWeight = Math.min(...weights);
            const weightRange = maxWeight - minWeight;
            
            document.getElementById('statGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avgWeight.toFixed(1)}</div>
                    <div class="stat-label">å¹³å‡ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${maxWeight.toFixed(1)}</div>
                    <div class="stat-label">æœ€å¤§ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${minWeight.toFixed(1)}</div>
                    <div class="stat-label">æœ€å°ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weightRange.toFixed(1)}</div>
                    <div class="stat-label">ä½“é‡å¤‰å‹•å¹… (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weights.length}</div>
                    <div class="stat-label">æ¸¬å®šå›æ•°</div>
                </div>
            `;
            
            document.getElementById('statisticsSection').style.display = 'block';
            console.log('v0.36-debug: åŸºæœ¬çµ±è¨ˆè¡¨ç¤ºå®Œäº†');
        }
        
        // ã‚¹ã‚±ãƒ¼ãƒ«åˆ¥ãƒ‡ãƒ¼ã‚¿é›†ç´„é–¢æ•°
        function aggregateDataByScale(data, scale) {
            const validData = data.filter(d => !isNaN(parseFloat(d.weight)));
            
            if (scale === 'hour') {
                // æ™‚é–“åˆ¥ã¯å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¿”ã™
                return validData.map(d => ({
                    label: `${d.date} ${d.time || ''}`,
                    date: d.date,
                    weight: parseFloat(d.weight),
                    min: parseFloat(d.weight),
                    max: parseFloat(d.weight),
                    avg: parseFloat(d.weight)
                }));
            }
            
            const grouped = {};
            
            validData.forEach(d => {
                let key;
                const date = new Date(d.date);
                
                if (scale === 'day') {
                    key = d.date;
                } else if (scale === 'week') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    key = weekStart.toISOString().split('T')[0];
                } else if (scale === 'month') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(parseFloat(d.weight));
            });
            
            return Object.keys(grouped).sort().map(key => {
                const weights = grouped[key];
                return {
                    label: key,
                    date: key,
                    min: Math.min(...weights),
                    max: Math.max(...weights),
                    avg: weights.reduce((a, b) => a + b, 0) / weights.length,
                    count: weights.length
                };
            });
        }
        
        // ã‚°ãƒ©ãƒ•è¡¨ç¤º
        function displayCharts() {
            if (!weightData || weightData.length === 0) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (weightChart) {
                weightChart.destroy();
            }
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            // ã‚¹ã‚±ãƒ¼ãƒ«åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„
            const aggregatedData = aggregateDataByScale(weightData, currentScale);
            
            if (aggregatedData.length === 0) {
                console.warn('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const labels = aggregatedData.map(d => d.label);
            const minWeights = aggregatedData.map(d => d.min);
            const maxWeights = aggregatedData.map(d => d.max);
            const avgWeights = aggregatedData.map(d => d.avg);
            
            // Yè»¸ã®æœ€å°å€¤ã‚’å‹•çš„ã«è¨ˆç®—
            const allWeights = [...minWeights, ...maxWeights, ...avgWeights];
            const minWeight = Math.min(...allWeights);
            const yAxisMin = Math.max(50, Math.floor(minWeight - 5));
            
            // ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•
            const ctx1 = document.getElementById('weightChart').getContext('2d');
            const datasets = [];
            
            if (currentScale === 'hour') {
                datasets.push({
                    label: 'ä½“é‡ (kg)',
                    data: avgWeights,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.2,
                    fill: true
                });
            } else {
                datasets.push(
                    {
                        label: 'æœ€å¤§ä½“é‡ (kg)',
                        data: maxWeights,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.2
                    },
                    {
                        label: 'å¹³å‡ä½“é‡ (kg)',
                        data: avgWeights,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.2,
                        fill: true
                    },
                    {
                        label: 'æœ€å°ä½“é‡ (kg)',
                        data: minWeights,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.2
                    }
                );
            }
            
            weightChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ• (${{
                                'hour': 'æ™‚é–“åˆ¥',
                                'day': 'æ—¥åˆ¥',
                                'week': 'é€±åˆ¥',
                                'month': 'æœˆåˆ¥'
                            }[currentScale]})`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin,
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            }
                        }
                    }
                }
            });
            
            // æ›œæ—¥åˆ¥å¹³å‡ã‚°ãƒ©ãƒ•ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰
            const sortedData = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const validWeeklyData = sortedData.filter(d => !isNaN(parseFloat(d.weight)));
            const weeklyData = {};
            validWeeklyData.forEach(d => {
                if (d.date) {
                    const day = new Date(d.date).getDay();
                    if (!weeklyData[day]) weeklyData[day] = [];
                    weeklyData[day].push(parseFloat(d.weight));
                }
            });
            
            const weeklyLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weeklyAverages = weeklyLabels.map((_, i) => {
                const dayData = weeklyData[i];
                return dayData ? dayData.reduce((a, b) => a + b, 0) / dayData.length : 0;
            });
            
            const ctx2 = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'å¹³å‡ä½“é‡ (kg)',
                        data: weeklyAverages,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ›œæ—¥åˆ¥å¹³å‡ä½“é‡'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin,
                            title: {
                                display: true,
                                text: 'å¹³å‡ä½“é‡ (kg)'
                            }
                        }
                    }
                }
            });
            
            document.getElementById('chartsSection').style.display = 'block';
            console.log('v0.36.03: ã‚°ãƒ©ãƒ•è¡¨ç¤ºå®Œäº† - Yè»¸æœ€å°å€¤:', yAxisMin);
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadDemoData() {
            const today = new Date();
            weightData = [];
            
            console.log('ğŸ› DEBUG: loadDemoDataé–‹å§‹ - today:', today.toISOString());
            console.log('ğŸ› DEBUG: ãƒ«ãƒ¼ãƒ—é–‹å§‹ (i=30 to 0)');
            
            for (let i = 30; i >= 0; i--) {
                // ä¿®æ­£: ãƒŸãƒªç§’è¨ˆç®—ã§ç¢ºå®Ÿãªæ—¥ä»˜ç”Ÿæˆ
                const date = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateString = date.toISOString().split('T')[0];
                
                console.log(`ğŸ› DEBUG: i=${i}, date=${dateString}, time=${date.getTime()}`);
                
                const baseWeight = 72.0;
                const trend = -0.02 * i;
                const dailyVariation = (Math.random() - 0.5) * 1.0;
                const weight = baseWeight + trend + dailyVariation;
                
                const timings = ['morning', 'toilet', 'before_bath', 'after_bath'];
                const timing = timings[Math.floor(Math.random() * timings.length)];
                
                weightData.push({
                    id: `demo_${i}`,
                    date: dateString,
                    time: '08:00',
                    weight: weight.toFixed(1),
                    timing: timing,
                    memo: 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿'
                });
            }
            
            console.log('ğŸ› DEBUG: ç”Ÿæˆã•ã‚ŒãŸå…¨æ—¥ä»˜:');
            const allDates = weightData.map(d => d.date);
            console.log(allDates);
            
            console.log('ğŸ› DEBUG: é‡è¤‡ãƒã‚§ãƒƒã‚¯:');
            const uniqueDates = [...new Set(allDates)];
            console.log(`ç·æ•°: ${allDates.length}, ä¸€æ„æ•°: ${uniqueDates.length}`);
            if (allDates.length !== uniqueDates.length) {
                console.error('ğŸš¨ é‡è¤‡ç™ºè¦‹ï¼');
                const duplicates = allDates.filter((date, index) => allDates.indexOf(date) !== index);
                console.error('é‡è¤‡æ—¥ä»˜:', [...new Set(duplicates)]);
            } else {
                console.log('âœ… é‡è¤‡ãªã—');
            }
            
            dataStatus.innerHTML = `<span class="success">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ ${weightData.length}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</span>`;
            dataStatus.className = 'status success';
            
            displayBasicStatistics();
            displayCharts();
            analyzeBtn.disabled = false;
            
            console.log('v0.36-debug: ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', weightData.length, 'ä»¶');
        }
        
        // ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—
        function calculateTrend(weights) {
            const n = weights.length;
            const x = Array.from({length: n}, (_, i) => i);
            const y = weights;
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            const yMean = sumY / n;
            const totalSumSquares = y.reduce((sum, yi) => sum + Math.pow(yi - yMean, 2), 0);
            const residualSumSquares = y.reduce((sum, yi, i) => {
                const predicted = slope * x[i] + intercept;
                return sum + Math.pow(yi - predicted, 2);
            }, 0);
            const r2 = 1 - (residualSumSquares / totalSumSquares);
            
            const direction = slope > 0.05 ? 'å¢—åŠ å‚¾å‘' : slope < -0.05 ? 'æ¸›å°‘å‚¾å‘' : 'å®‰å®š';
            const prediction = slope * (n + 7) + intercept;
            const change = prediction - weights[weights.length - 1];
            
            return {
                direction,
                rate: slope,
                accuracy: Math.round(r2 * 100),
                prediction,
                change
            };
        }
        
        // AIæ”¹å–„ææ¡ˆç”Ÿæˆ
        function generateInsights(data, trend) {
            const insights = [];
            
            if (trend.direction === 'å¢—åŠ å‚¾å‘') {
                insights.push('ä½“é‡ãŒå¢—åŠ å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚é£Ÿäº‹å†…å®¹ã®è¦‹ç›´ã—ã‚„é‹å‹•é‡ã®å¢—åŠ ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†');
                insights.push('ã‚«ãƒ­ãƒªãƒ¼æ‘‚å–é‡ã®è¨˜éŒ²ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™');
            } else if (trend.direction === 'æ¸›å°‘å‚¾å‘') {
                insights.push('ä½“é‡æ¸›å°‘ãŒé †èª¿ã§ã™ã€‚ç¾åœ¨ã®ç”Ÿæ´»ç¿’æ…£ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†');
                insights.push('ç­‹åŠ›ç¶­æŒã®ãŸã‚ã®é©åº¦ãªé‹å‹•ã‚‚ä½µã›ã¦è¡Œã„ã¾ã—ã‚‡ã†');
            } else {
                insights.push('ä½“é‡ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚å¥åº·çš„ãªçŠ¶æ…‹ã‚’ç¶­æŒã§ãã¦ã„ã¾ã™');
            }
            
            const uniqueDates = new Set(data.map(d => d.date)).size;
            const totalDays = Math.ceil((new Date() - new Date(data[0].date)) / (1000 * 60 * 60 * 24));
            const frequency = uniqueDates / totalDays;
            
            if (frequency < 0.5) {
                insights.push('æ¸¬å®šé »åº¦ã‚’ä¸Šã’ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ­£ç¢ºãªä½“é‡ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™');
            }
            
            return insights;
        }
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³éè¡¨ç¤º
        function hideAllSections() {
            document.getElementById('statisticsSection').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('mlSection').style.display = 'none';
            document.getElementById('insightsSection').style.display = 'none';
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.loadDemoData = loadDemoData;
        
        console.log('v0.36-debug: ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† - æ—¥ä»˜è¡¨ç¤ºã¨Yè»¸ã‚¹ã‚±ãƒ¼ãƒ«ä¿®æ­£ç‰ˆ');
    </script>
</body>
</html>