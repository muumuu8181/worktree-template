<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeLog AIåˆ†æã‚·ã‚¹ãƒ†ãƒ  v0.37-Step2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            font-weight: 300; 
        }
        .header p { 
            font-size: 1.1em; 
            opacity: 0.9; 
        }
        .content { 
            padding: 30px; 
        }
        .section { 
            margin: 5px 0; 
            padding: 8px; 
            border: 1px solid #eee; 
            border-radius: 6px; 
            transition: all 0.3s ease;
        }
        .section:hover { 
            border-color: #667eea; 
            box-shadow: 0 2px 8px rgba(102,126,234,0.1); 
        }
        .section h2 { 
            color: #333; 
            margin-bottom: 5px; 
            padding-bottom: 3px; 
            border-bottom: 1px solid #eee; 
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 1em; 
            margin: 5px; 
            transition: all 0.3s ease;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102,126,234,0.3); 
        }
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            font-weight: bold; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .stat-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
            margin: 10px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 8px 12px; 
            border-radius: 6px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .stat-value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: #667eea; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 3px; 
            font-size: 12px;
        }
        .chart-container { 
            margin: 20px 0; 
            text-align: center; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 3px 0;">
                <div>
                    <h1 style="font-size: 18px; margin: 0; line-height: 1;">LifeLog AIåˆ†æã‚·ã‚¹ãƒ†ãƒ  v0.37-Step2</h1>
                    <p style="margin: 0; font-size: 11px; line-height: 1;">é–¢æ•°åˆ†é›¢å¯¾å¿œç‰ˆ</p>
                </div>
                <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå³å´ï¼‰ -->
                <div style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                    <div id="authStatus" class="status info" style="margin: 0; padding: 2px 6px; font-size: 10px;">èªè¨¼ãŒå¿…è¦ã§ã™</div>
                    <button id="loginBtn" class="btn" style="padding: 2px 6px; font-size: 10px;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button id="logoutBtn" class="btn" style="display:none; padding: 2px 6px; font-size: 10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div id="userInfo" style="display: none; font-size: 10px;">
                        <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong> <span id="userName"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="section">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <button id="weightTabBtn" class="btn" style="padding: 4px 12px; background: #444; color: white;">ä½“é‡ç®¡ç†</button>
                    <button id="mealTabBtn" class="btn" style="padding: 4px 12px;">é£Ÿäº‹ç®¡ç†</button>
                    <button id="exerciseTabBtn" class="btn" style="padding: 4px 12px;">é‹å‹•ç®¡ç†</button>
                </div>
            </div>
            
            <!-- ä½“é‡ç®¡ç†ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="weightTabContent" class="tab-content">
                <!-- ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <h2 style="margin: 0; font-size: 14px;">ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
                        <button id="fetchDataBtn" class="btn" style="padding: 2px 6px;" disabled>ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                        <button id="analyzeBtn" class="btn" style="padding: 2px 6px;" disabled>MLåˆ†æ</button>
                        <div id="dataStatus" class="status info" style="margin: 0; padding: 2px 6px; font-size: 11px;">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    </div>
                </div>
            </div>

            <!-- é£Ÿäº‹ç®¡ç†ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="mealTabContent" class="tab-content" style="display: none;">
                <div class="section">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <h2 style="margin: 0; font-size: 14px;">é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
                        <button id="fetchMealDataBtn" class="btn" style="padding: 2px 6px;" disabled>é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                        <button id="analyzeMealBtn" class="btn" style="padding: 2px 6px;" disabled>é£Ÿäº‹MLåˆ†æ</button>
                        <div id="mealDataStatus" class="status info" style="margin: 0; padding: 2px 6px; font-size: 11px;">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    </div>
                </div>
            </div>

            <!-- é‹å‹•ç®¡ç†ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="exerciseTabContent" class="tab-content" style="display: none;">
                <div class="section">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <h2 style="margin: 0; font-size: 14px;">é‹å‹•ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
                        <button id="fetchExerciseDataBtn" class="btn" style="padding: 2px 6px;" disabled>é‹å‹•ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                        <button id="analyzeExerciseBtn" class="btn" style="padding: 2px 6px;" disabled>é‹å‹•MLåˆ†æ</button>
                        <div id="exerciseDataStatus" class="status info" style="margin: 0; padding: 2px 6px; font-size: 11px;">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    </div>
                </div>
            </div>
            
            <!-- åŸºæœ¬çµ±è¨ˆ -->
            <div class="section" id="statisticsSection" style="display: none;">
                <h2 style="font-size: 12px; margin: 0 0 3px 0;">åŸºæœ¬çµ±è¨ˆ</h2>
                <div class="stat-grid" id="statGrid"></div>
            </div>
            
            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
            <div class="section" id="chartsSection" style="display: none;">
                <h2 style="font-size: 12px; margin: 0 0 3px 0;">ã‚°ãƒ©ãƒ•è¡¨ç¤º</h2>
                <div style="margin: 15px 0;">
                    <label>è¡¨ç¤ºã‚¹ã‚±ãƒ¼ãƒ«: </label>
                    <button id="scaleHourBtn" class="btn">æ™‚é–“åˆ¥</button>
                    <button id="scaleDayBtn" class="btn" style="background: #444;">æ—¥åˆ¥</button>
                    <button id="scaleWeekBtn" class="btn">é€±åˆ¥</button>
                    <button id="scaleMonthBtn" class="btn">æœˆåˆ¥</button>
                </div>
                <div class="chart-container">
                    <canvas id="weightChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- æ¸¬å®šå›æ•°å¯è¦–åŒ– -->
            <div class="section" id="measurementFrequencySection" style="display: none;">
                <h2>æ¸¬å®šå›æ•°å¯è¦–åŒ–</h2>
                <div style="margin: 15px 0;">
                    <label>è¡¨ç¤ºæœŸé–“: </label>
                    <button id="freq1WeekBtn" class="btn" style="background: #444;">1é€±é–“</button>
                    <button id="freq4WeekBtn" class="btn">4é€±é–“</button>
                </div>
                <div id="frequencyGrid" style="margin: 20px 0; display: flex; flex-direction: column; align-items: center;">
                    <!-- æ¸¬å®šå›æ•°ã‚°ãƒªãƒƒãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
                <div style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <p><strong>ç›®æ¨™ï¼š</strong> 1æ—¥10å›ã®æ¸¬å®šã§ä½“é‡å¤‰åŒ–ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¾ã—ã‚‡ã†</p>
                    <p><strong>ã‚³ãƒ„ï¼š</strong> æ™‚é–“ã‚’ç©ºã‘ã¦æ¸¬å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <!-- æ©Ÿæ¢°å­¦ç¿’çµæœ -->
            <div class="section" id="mlSection" style="display: none;">
                <h2>æ©Ÿæ¢°å­¦ç¿’åˆ†æçµæœ</h2>
                <div id="mlResults"></div>
            </div>
            
            <!-- AIæ”¹å–„ææ¡ˆ -->
            <div class="section" id="insightsSection" style="display: none;">
                <h2>AIæ”¹å–„ææ¡ˆ</h2>
                <div id="insights"></div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase v8 SDK - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- ğŸ”„ Step 1: Firebaseè¨­å®šåˆ†é›¢ -->
    <script src="config/firebase.js"></script>
    
    <!-- ğŸ”„ Step 2: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°åˆ†é›¢ -->
    <script src="utils/helpers.js"></script>
    
    <script>
        console.log('v0.40.01: æ—¥ä»˜é‡è¤‡ãƒã‚°ä¿®æ­£ç‰ˆé–‹å§‹');
        
        // ğŸ”„ Step 0: Migration Log System
        const MigrationLog = {
            log: (step, action, data) => {
                const timestamp = new Date().toISOString();
                const logMessage = `ğŸ”„ [Step${step}] ${action}`;
                console.log(logMessage + ':', data);
                
                // LocalStorageã«ã‚‚ä¿å­˜
                try {
                    const logs = JSON.parse(localStorage.getItem('migrationLogs') || '[]');
                    logs.push({step, action, data, timestamp});
                    localStorage.setItem('migrationLogs', JSON.stringify(logs));
                } catch (e) {
                    console.warn('ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                }
            },
            
            getLogs: (stepNumber = null) => {
                try {
                    const logs = JSON.parse(localStorage.getItem('migrationLogs') || '[]');
                    return stepNumber ? logs.filter(l => l.step === stepNumber) : logs;
                } catch (e) {
                    console.warn('ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                    return [];
                }
            },
            
            clearLogs: () => {
                localStorage.removeItem('migrationLogs');
                console.log('ğŸ”„ Migration logs cleared');
            }
        };
        
        // Step 0 é–‹å§‹ãƒ­ã‚°
        MigrationLog.log(0, 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–', {
            version: 'v0.37-Step2',
            timestamp: Date.now(),
            userAgent: navigator.userAgent
        });
        
        // ğŸ”„ Step 1: Firebaseè¨­å®šåˆ†é›¢ç‰ˆåˆæœŸåŒ–
        const {auth, database} = FirebaseConfig.init();
        
        // Step 1 ãƒ­ã‚°
        MigrationLog.log(1, 'ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«', {
            action: 'è¨­å®šåˆ†é›¢é©ç”¨',
            oldMethod: 'firebase.initializeApp(firebaseConfig)',
            newMethod: 'FirebaseConfig.init()',
            timestamp: Date.now()
        });
        
        console.log('v0.40.01: Firebase v8 åˆæœŸåŒ–å®Œäº†');
        
        let userData = null;
        let weightData = null;
        let weightChart = null;
        let weeklyChart = null;
        
        // DOMè¦ç´ 
        const authStatus = document.getElementById('authStatus');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const dataStatus = document.getElementById('dataStatus');
        const scaleHourBtn = document.getElementById('scaleHourBtn');
        const scaleDayBtn = document.getElementById('scaleDayBtn');
        const scaleWeekBtn = document.getElementById('scaleWeekBtn');
        const scaleMonthBtn = document.getElementById('scaleMonthBtn');
        const freq1WeekBtn = document.getElementById('freq1WeekBtn');
        const freq4WeekBtn = document.getElementById('freq4WeekBtn');
        
        let currentTimeScale = 'day';
        
        // èªè¨¼çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged((user) => {
            console.log('v0.40.01: èªè¨¼çŠ¶æ…‹å¤‰æ›´', user ? 'èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼');
            MigrationLog.log(0, 'èªè¨¼çŠ¶æ…‹å¤‰æ›´', {
                user: user?.email || 'æœªèªè¨¼',
                uid: user?.uid || null,
                timestamp: Date.now()
            });
            if (user) {
                userData = user;
                authStatus.innerHTML = '<span class="success">èªè¨¼æ¸ˆã¿</span>';
                authStatus.className = 'status success';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userInfo.style.display = 'block';
                userName.textContent = user.displayName || user.email;
                fetchDataBtn.disabled = false;
                dataStatus.innerHTML = '<span class="info">ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æº–å‚™ãŒã§ãã¾ã—ãŸ</span>';
                dataStatus.className = 'status info';
                
                // é£Ÿäº‹ãƒ»é‹å‹•ãƒœã‚¿ãƒ³ã‚‚æœ‰åŠ¹åŒ–
                document.getElementById('fetchMealDataBtn').disabled = false;
                document.getElementById('fetchExerciseDataBtn').disabled = false;
                document.getElementById('mealDataStatus').innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æº–å‚™ãŒã§ãã¾ã—ãŸ';
                document.getElementById('mealDataStatus').className = 'status info';
                document.getElementById('exerciseDataStatus').innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æº–å‚™ãŒã§ãã¾ã—ãŸ';
                document.getElementById('exerciseDataStatus').className = 'status info';
            } else {
                userData = null;
                authStatus.innerHTML = '<span class="info">èªè¨¼ãŒå¿…è¦ã§ã™</span>';
                authStatus.className = 'status info';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
                fetchDataBtn.disabled = true;
                analyzeBtn.disabled = true;
                dataStatus.innerHTML = '<span class="info">èªè¨¼å¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</span>';
                dataStatus.className = 'status info';
                hideAllSections();
            }
        });
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
        loginBtn.addEventListener('click', async () => {
            try {
                console.log('v0.40.01: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œé–‹å§‹');
                authStatus.innerHTML = '<span class="info">èªè¨¼ä¸­...</span>';
                authStatus.className = 'status info';
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                const result = await auth.signInWithPopup(provider);
                console.log('v0.40.01: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', result.user.email);
            } catch (error) {
                console.error('v0.40.01: èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                authStatus.innerHTML = '<span class="error">èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                authStatus.className = 'status error';
            }
        });
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
        logoutBtn.addEventListener('click', async () => {
            try {
                console.log('v0.40.01: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ');
                await auth.signOut();
                hideAllSections();
            } catch (error) {
                console.error('v0.40.01: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        });
        
        // ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒœã‚¿ãƒ³ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ãƒ‘ã‚¹ï¼‰
        fetchDataBtn.addEventListener('click', async () => {
            if (!userData) {
                dataStatus.innerHTML = '<span class="error">èªè¨¼ãŒå¿…è¦ã§ã™</span>';
                dataStatus.className = 'status error';
                return;
            }
            
            try {
                console.log('v0.40.01: ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userData.uid);
                MigrationLog.log(0, 'ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹', {
                    userId: userData.uid,
                    path: `users/${userData.uid}/weights`
                });
                dataStatus.innerHTML = '<span class="info">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</span>';
                dataStatus.className = 'status info';
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜ãƒ‘ã‚¹: users/${currentUser.uid}/weights
                const userRef = database.ref(`users/${userData.uid}/weights`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    weightData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ', weightData.length, 'ä»¶');
                    MigrationLog.log(0, 'ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ', {
                        dataCount: weightData.length,
                        firstDate: weightData[0]?.date,
                        lastDate: weightData[weightData.length - 1]?.date
                    });
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: å…¨ãƒ‡ãƒ¼ã‚¿:');
                    weightData.forEach((d, i) => {
                        console.log(`${i}: ${d.date} - ${d.weight}kg`);
                        // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è©³ç´°è¡¨ç¤º
                        console.log('ğŸ” è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', d);
                        const fields = Object.keys(d);
                        console.log('ğŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§:', fields);
                        fields.forEach(field => {
                            if (field !== 'id' && field !== 'date' && field !== 'weight') {
                                if (field === 'clothing' && d[field]) {
                                    console.log(`  ğŸ“Œ ${field}:`, d[field]);
                                    console.log(`    ğŸ‘• clothingè©³ç´°:`, JSON.stringify(d[field], null, 2));
                                } else {
                                    console.log(`  ğŸ“Œ ${field}: ${d[field]}`);
                                }
                            }
                        });
                    });
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œå‡º
                    const errorData = weightData.filter(d => 
                        d.weight === undefined || 
                        d.weight === null || 
                        d.weight === '' || 
                        isNaN(parseFloat(d.weight))
                    );
                    if (errorData.length > 0) {
                        console.warn('âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œå‡º:', errorData.length, 'ä»¶');
                        errorData.forEach(d => console.warn(`ã‚¨ãƒ©ãƒ¼: ${d.date} - ${d.weight}kg`));
                        dataStatus.innerHTML = `<span class="error">${weightData.length}ä»¶å–å¾— (âš ï¸ ${errorData.length}ä»¶ã‚¨ãƒ©ãƒ¼)</span>`;
                    } else {
                        dataStatus.innerHTML = `<span class="success">${weightData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ</span>`;
                    }
                    
                    // æ—¥ä»˜é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const allDates = weightData.map(d => d.date);
                    const uniqueDates = [...new Set(allDates)];
                    console.log('ğŸ› å®Ÿãƒ‡ãƒ¼ã‚¿DEBUG: é‡è¤‡ãƒã‚§ãƒƒã‚¯:');
                    console.log(`ç·æ•°: ${allDates.length}, ä¸€æ„æ•°: ${uniqueDates.length}`);
                    if (allDates.length !== uniqueDates.length) {
                        console.error('ğŸš¨ å®Ÿãƒ‡ãƒ¼ã‚¿ã«æ—¥ä»˜é‡è¤‡ç™ºè¦‹ï¼');
                        const duplicates = allDates.filter((date, index) => allDates.indexOf(date) !== index);
                        console.error('é‡è¤‡æ—¥ä»˜:', [...new Set(duplicates)]);
                        
                        // é‡è¤‡æ—¥ä»˜ã®è©³ç´°
                        [...new Set(duplicates)].forEach(dupDate => {
                            const sameDateRecords = weightData.filter(d => d.date === dupDate);
                            console.error(`${dupDate} ã®è¨˜éŒ²:`, sameDateRecords);
                        });
                    }
                    
                    dataStatus.innerHTML = `<span class="success">${weightData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ</span>`;
                    dataStatus.className = 'status success';
                    
                    displayBasicStatistics();
                    displayCharts();
                    displayMeasurementFrequency(weightData);
                    analyzeBtn.disabled = false;
                    
                } else {
                    console.log('v0.40.01: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    dataStatus.innerHTML = '<span class="error">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½“é‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
                    dataStatus.className = 'status error';
                }
                
            } catch (error) {
                console.error('v0.40.01: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                dataStatus.innerHTML = `<span class="error">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</span>`;
                dataStatus.className = 'status error';
            }
        });
        
        // ã‚¹ã‚±ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        scaleHourBtn.addEventListener('click', () => setTimeScale('hour'));
        scaleDayBtn.addEventListener('click', () => setTimeScale('day'));
        scaleWeekBtn.addEventListener('click', () => setTimeScale('week'));
        scaleMonthBtn.addEventListener('click', () => setTimeScale('month'));
        
        // æ¸¬å®šå›æ•°è¡¨ç¤ºæœŸé–“åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
        freq1WeekBtn.addEventListener('click', () => setFrequencyPeriod('1week'));
        freq4WeekBtn.addEventListener('click', () => setFrequencyPeriod('4week'));
        
        function setFrequencyPeriod(period) {
            currentFrequencyPeriod = period;
            
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            [freq1WeekBtn, freq4WeekBtn].forEach(btn => {
                btn.style.background = '';
            });
            
            if (period === '1week') {
                freq1WeekBtn.style.background = '#444';
            } else {
                freq4WeekBtn.style.background = '#444';
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å†è¡¨ç¤º
            if (weightData && weightData.length > 0) {
                displayMeasurementFrequency(weightData);
            }
        }
        
        function setTimeScale(scale) {
            currentTimeScale = scale;
            
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            [scaleHourBtn, scaleDayBtn, scaleWeekBtn, scaleMonthBtn].forEach(btn => {
                btn.style.background = '';
            });
            
            const activeBtn = {
                hour: scaleHourBtn,
                day: scaleDayBtn, 
                week: scaleWeekBtn,
                month: scaleMonthBtn
            }[scale];
            activeBtn.style.background = '#444';
            
            // ã‚°ãƒ©ãƒ•ã‚’å†æç”»
            if (weightData) {
                displayCharts();
            }
        }
        
        // æ©Ÿæ¢°å­¦ç¿’åˆ†æãƒœã‚¿ãƒ³
        analyzeBtn.addEventListener('click', async () => {
            if (!weightData || weightData.length < 5) {
                document.getElementById('mlResults').innerHTML = '<span class="error">åˆ†æã«ã¯æœ€ä½5ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™</span>';
                document.getElementById('mlSection').style.display = 'block';
                return;
            }
            
            try {
                console.log('v0.40.01: æ©Ÿæ¢°å­¦ç¿’åˆ†æé–‹å§‹');
                const weights = weightData.map(d => parseFloat(d.weight)).filter(w => !isNaN(w));
                // ğŸ”„ Step 2: åˆ†é›¢ç‰ˆé–¢æ•°å‘¼ã³å‡ºã—
                const trend = DataUtils.calculateTrend(weights);
                // ğŸ”„ Step 2: åˆ†é›¢ç‰ˆé–¢æ•°å‘¼ã³å‡ºã—
                const insights = DataUtils.generateInsights(weightData, trend);
                
                document.getElementById('mlResults').innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h4>ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h4>
                        <p><strong>ä½“é‡å¤‰åŒ–å‚¾å‘:</strong> ${trend.direction}</p>
                        <p><strong>å¤‰åŒ–ç‡:</strong> ${trend.rate.toFixed(3)}kg/æ—¥</p>
                        <p><strong>äºˆæ¸¬ç²¾åº¦:</strong> ${trend.accuracy}%</p>
                        
                        <h4>7æ—¥å¾Œäºˆæ¸¬</h4>
                        <p><strong>äºˆæ¸¬ä½“é‡:</strong> ${trend.prediction.toFixed(1)}kg</p>
                        <p><strong>å¤‰åŒ–é‡:</strong> ${trend.change > 0 ? '+' : ''}${trend.change.toFixed(1)}kg</p>
                    </div>
                `;
                
                document.getElementById('insights').innerHTML = `
                    <h3>AIæ”¹å–„ææ¡ˆ</h3>
                    <ul style="list-style: none;">
                        ${insights.map(insight => `<li style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #ffc107;">${insight}</li>`).join('')}
                    </ul>
                `;
                
                document.getElementById('mlSection').style.display = 'block';
                document.getElementById('insightsSection').style.display = 'block';
                
                console.log('v0.40.01: æ©Ÿæ¢°å­¦ç¿’åˆ†æå®Œäº†');
                
            } catch (error) {
                console.error('v0.40.01: åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('mlResults').innerHTML = '<span class="error">åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                document.getElementById('mlSection').style.display = 'block';
            }
        });
        
        // åŸºæœ¬çµ±è¨ˆè¡¨ç¤º
        function displayBasicStatistics() {
            if (!weightData || weightData.length === 0) return;
            
            const weights = weightData.map(d => parseFloat(d.weight)).filter(w => !isNaN(w));
            if (weights.length === 0) return;
            
            const avgWeight = weights.reduce((a, b) => a + b, 0) / weights.length;
            const maxWeight = Math.max(...weights);
            const minWeight = Math.min(...weights);
            const weightRange = maxWeight - minWeight;
            
            document.getElementById('statGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avgWeight.toFixed(1)}</div>
                    <div class="stat-label">å¹³å‡ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${maxWeight.toFixed(1)}</div>
                    <div class="stat-label">æœ€å¤§ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${minWeight.toFixed(1)}</div>
                    <div class="stat-label">æœ€å°ä½“é‡ (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weightRange.toFixed(1)}</div>
                    <div class="stat-label">ä½“é‡å¤‰å‹•å¹… (kg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${weights.length}</div>
                    <div class="stat-label">æ¸¬å®šå›æ•°</div>
                </div>
            `;
            
            document.getElementById('statisticsSection').style.display = 'block';
            console.log('v0.40.01: åŸºæœ¬çµ±è¨ˆè¡¨ç¤ºå®Œäº†');
        }
        
        // ã‚°ãƒ©ãƒ•è¡¨ç¤º
        function displayCharts() {
            if (!weightData || weightData.length === 0) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (weightChart) {
                weightChart.destroy();
            }
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            console.log(`ğŸ”„ ã‚°ãƒ©ãƒ•æ›´æ–°: ${currentTimeScale}ã‚¹ã‚±ãƒ¼ãƒ«`);
            
            // ã‚¹ã‚±ãƒ¼ãƒ«åˆ¥ã§ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„
            // ğŸ”„ Step 2: åˆ†é›¢ç‰ˆé–¢æ•°å‘¼ã³å‡ºã—
            const aggregatedData = DataUtils.aggregateDataByScale(weightData, currentTimeScale);
            MigrationLog.log(2, 'ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«', {
                action: 'é–¢æ•°å‘¼ã³å‡ºã—å¤‰æ›´',
                function: 'aggregateDataByScale',
                oldMethod: 'aggregateDataByScale()',
                newMethod: 'DataUtils.aggregateDataByScale()'
            });
            
            console.log('ğŸ”„ é›†ç´„å¾Œãƒ‡ãƒ¼ã‚¿:', aggregatedData);
            
            // Yè»¸ã®ç¯„å›²ã‚’ä¸­å¤®å€¤Â±2kgã§å‹•çš„ã«è¨ˆç®—
            const allValues = aggregatedData.flatMap(d => [d.min, d.max, d.avg]).filter(v => !isNaN(v));
            const medianWeight = allValues.sort((a, b) => a - b)[Math.floor(allValues.length / 2)];
            const yAxisMin = Math.floor(medianWeight - 2);
            const yAxisMax = Math.ceil(medianWeight + 2);
            
            // ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•
            const ctx1 = document.getElementById('weightChart').getContext('2d');
            const datasets = [];
            
            // æœ€å¤§å€¤ãƒ»æœ€å°å€¤ãƒ»å¹³å‡å€¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
            datasets.push({
                label: 'æœ€å¤§å€¤',
                data: aggregatedData.map(d => d.max),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.2,
                fill: false
            });
            
            datasets.push({
                label: 'å¹³å‡å€¤',
                data: aggregatedData.map(d => d.avg),
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.2,
                fill: true
            });
            
            datasets.push({
                label: 'æœ€å°å€¤',
                data: aggregatedData.map(d => d.min),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.2,
                fill: false
            });
            
            weightChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: aggregatedData.map(d => d.label),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin,
                            max: yAxisMax,
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            }
                        }
                    }
                }
            });
            
            // æ›œæ—¥åˆ¥å¹³å‡ã‚°ãƒ©ãƒ•
            const weeklyData = {};
            weightData.forEach(d => {
                if (d.date) {
                    const day = new Date(d.date).getDay();
                    if (!weeklyData[day]) weeklyData[day] = [];
                    weeklyData[day].push(parseFloat(d.weight));
                }
            });
            
            const weeklyLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weeklyAverages = weeklyLabels.map((_, i) => {
                const dayData = weeklyData[i];
                return dayData ? dayData.reduce((a, b) => a + b, 0) / dayData.length : 0;
            });
            
            const ctx2 = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'å¹³å‡ä½“é‡ (kg)',
                        data: weeklyAverages,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ›œæ—¥åˆ¥å¹³å‡ä½“é‡'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yAxisMin,
                            title: {
                                display: true,
                                text: 'å¹³å‡ä½“é‡ (kg)'
                            }
                        }
                    }
                }
            });
            
            document.getElementById('chartsSection').style.display = 'block';
            console.log('v0.40.01: ã‚°ãƒ©ãƒ•è¡¨ç¤ºå®Œäº† - Yè»¸ç¯„å›²:', yAxisMin, '-', yAxisMax, 'kg (ä¸­å¤®å€¤Â±2kg)');
        }
        
        // æ¸¬å®šå›æ•°å¯è¦–åŒ–æ©Ÿèƒ½
        let currentFrequencyPeriod = '1week'; // 1week or 4week
        
        function displayMeasurementFrequency(data) {
            console.log('v0.40.01: æ¸¬å®šå›æ•°å¯è¦–åŒ–é–‹å§‹');
            
            // æ—¥ä»˜åˆ¥ã®æ¸¬å®šå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const measurementCounts = {};
            data.forEach(d => {
                if (d.date) {
                    const dateKey = d.date;
                    measurementCounts[dateKey] = (measurementCounts[dateKey] || 0) + 1;
                }
            });
            
            console.log('v0.40.01: æ¸¬å®šå›æ•°ãƒ‡ãƒ¼ã‚¿:', measurementCounts);
            
            // è¡¨ç¤ºæœŸé–“ã«å¿œã˜ã¦ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
            generateFrequencyGrid(measurementCounts);
            
            document.getElementById('measurementFrequencySection').style.display = 'block';
            console.log('v0.40.01: æ¸¬å®šå›æ•°å¯è¦–åŒ–å®Œäº†');
        }
        
        function generateFrequencyGrid(measurementCounts) {
            const gridContainer = document.getElementById('frequencyGrid');
            gridContainer.innerHTML = '';
            
            // æœŸé–“è¨­å®š
            const today = new Date();
            const daysToShow = currentFrequencyPeriod === '1week' ? 7 : 28; // 4é€±é–“ = 28æ—¥
            
            // æ›œæ—¥ãƒ©ãƒ™ãƒ«
            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            
            // ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
            const grid = document.createElement('div');
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 10px;
                max-width: 600px;
                margin: 0 auto;
            `;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ›œæ—¥ï¼‰
            dayLabels.forEach(label => {
                const header = document.createElement('div');
                header.textContent = label;
                header.style.cssText = `
                    text-align: center;
                    font-weight: bold;
                    padding: 8px;
                    background: #333;
                    color: white;
                    border-radius: 4px;
                `;
                grid.appendChild(header);
            });
            
            // é€±æ•°ã«å¿œã˜ã¦ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
            const weeksToShow = Math.ceil(daysToShow / 7);
            
            for (let week = 0; week < weeksToShow; week++) {
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    const dayIndex = week * 7 + dayOfWeek;
                    
                    if (dayIndex >= daysToShow) {
                        // ç©ºã®ã‚»ãƒ«ã‚’è¿½åŠ 
                        const emptyCell = document.createElement('div');
                        grid.appendChild(emptyCell);
                        continue;
                    }
                    
                    const targetDate = new Date(today);
                    targetDate.setDate(today.getDate() - (daysToShow - 1 - dayIndex));
                    const dateKey = targetDate.toISOString().split('T')[0];
                    
                    const measurementCount = measurementCounts[dateKey] || 0;
                    
                    // ã‚»ãƒ«ä½œæˆ
                    const cell = document.createElement('div');
                    cell.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: flex-end;
                        height: 120px;
                        width: 60px;
                        border: 2px solid #ddd;
                        border-radius: 6px;
                        padding: 4px;
                        background: #f9f9f9;
                        position: relative;
                    `;
                    
                    // æ—¥ä»˜è¡¨ç¤º
                    const dateLabel = document.createElement('div');
                    dateLabel.textContent = targetDate.getDate();
                    dateLabel.style.cssText = `
                        position: absolute;
                        top: 4px;
                        font-size: 12px;
                        font-weight: bold;
                        color: #666;
                    `;
                    cell.appendChild(dateLabel);
                    
                    // ãƒã‚¹ç›®ï¼ˆç©ã¿ä¸Šã’ï¼‰è¡¨ç¤º
                    const maxSquares = 10; // æœ€å¤§10å€‹ã®ãƒã‚¹ç›®
                    const squareSize = 8;
                    const squareGap = 2;
                    
                    for (let i = 0; i < Math.min(measurementCount, maxSquares); i++) {
                        const square = document.createElement('div');
                        square.style.cssText = `
                            width: ${squareSize}px;
                            height: ${squareSize}px;
                            background: ${i < measurementCount ? '#4CAF50' : '#eee'};
                            border: 1px solid #ccc;
                            margin-bottom: ${squareGap}px;
                        `;
                        cell.appendChild(square);
                    }
                    
                    // æ¸¬å®šå›æ•°ãŒ10ã‚’è¶…ãˆãŸå ´åˆã®è¡¨ç¤º
                    if (measurementCount > maxSquares) {
                        const overflowLabel = document.createElement('div');
                        overflowLabel.textContent = `+${measurementCount - maxSquares}`;
                        overflowLabel.style.cssText = `
                            font-size: 10px;
                            color: #ff5722;
                            font-weight: bold;
                            margin-top: 2px;
                        `;
                        cell.appendChild(overflowLabel);
                    }
                    
                    // æ¸¬å®šå›æ•°è¡¨ç¤º
                    const countLabel = document.createElement('div');
                    countLabel.textContent = measurementCount;
                    countLabel.style.cssText = `
                        font-size: 11px;
                        font-weight: bold;
                        color: ${measurementCount >= 5 ? '#4CAF50' : measurementCount >= 1 ? '#ff9800' : '#ccc'};
                        margin-top: 2px;
                    `;
                    cell.appendChild(countLabel);
                    
                    grid.appendChild(cell);
                }
            }
            
            gridContainer.appendChild(grid);
            
            // çµ±è¨ˆæƒ…å ±ã‚’è¿½åŠ 
            const stats = document.createElement('div');
            stats.style.cssText = `
                margin-top: 20px;
                padding: 15px;
                background: #e3f2fd;
                border-radius: 8px;
                text-align: center;
            `;
            
            const totalMeasurements = Object.values(measurementCounts).reduce((sum, count) => sum + count, 0);
            const activeDays = Object.keys(measurementCounts).length;
            const avgPerDay = activeDays > 0 ? (totalMeasurements / activeDays).toFixed(1) : 0;
            
            stats.innerHTML = `
                <strong>æ¸¬å®šçµ±è¨ˆ (${currentFrequencyPeriod === '1week' ? '1é€±é–“' : '4é€±é–“'})</strong><br>
                ç·æ¸¬å®šå›æ•°: ${totalMeasurements}å› | 
                æ¸¬å®šæ—¥æ•°: ${activeDays}æ—¥ | 
                1æ—¥å¹³å‡: ${avgPerDay}å›
            `;
            
            gridContainer.appendChild(stats);
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadDemoData() {
            const today = new Date();
            weightData = [];
            
            console.log('ğŸ› DEBUG: loadDemoDataé–‹å§‹ - today:', today.toISOString());
            console.log('ğŸ› DEBUG: ãƒ«ãƒ¼ãƒ—é–‹å§‹ (i=30 to 0)');
            
            for (let i = 30; i >= 0; i--) {
                // ä¿®æ­£: ãƒŸãƒªç§’è¨ˆç®—ã§ç¢ºå®Ÿãªæ—¥ä»˜ç”Ÿæˆ
                const date = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateString = date.toISOString().split('T')[0];
                
                console.log(`ğŸ› DEBUG: i=${i}, date=${dateString}, time=${date.getTime()}`);
                
                const baseWeight = 72.0;
                const trend = -0.02 * i;
                const dailyVariation = (Math.random() - 0.5) * 1.0;
                const weight = baseWeight + trend + dailyVariation;
                
                const timings = ['morning', 'toilet', 'before_bath', 'after_bath'];
                const timing = timings[Math.floor(Math.random() * timings.length)];
                
                weightData.push({
                    id: `demo_${i}`,
                    date: dateString,
                    time: '08:00',
                    weight: weight.toFixed(1),
                    timing: timing,
                    memo: 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿'
                });
            }
            
            console.log('ğŸ› DEBUG: ç”Ÿæˆã•ã‚ŒãŸå…¨æ—¥ä»˜:');
            const allDates = weightData.map(d => d.date);
            console.log(allDates);
            
            console.log('ğŸ› DEBUG: é‡è¤‡ãƒã‚§ãƒƒã‚¯:');
            const uniqueDates = [...new Set(allDates)];
            console.log(`ç·æ•°: ${allDates.length}, ä¸€æ„æ•°: ${uniqueDates.length}`);
            if (allDates.length !== uniqueDates.length) {
                console.error('ğŸš¨ é‡è¤‡ç™ºè¦‹ï¼');
                const duplicates = allDates.filter((date, index) => allDates.indexOf(date) !== index);
                console.error('é‡è¤‡æ—¥ä»˜:', [...new Set(duplicates)]);
            } else {
                console.log('âœ… é‡è¤‡ãªã—');
            }
            
            dataStatus.innerHTML = `<span class="success">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ ${weightData.length}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</span>`;
            dataStatus.className = 'status success';
            
            displayBasicStatistics();
            displayCharts();
            analyzeBtn.disabled = false;
            
            console.log('v0.40.01: ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', weightData.length, 'ä»¶');
        }
        
        // ğŸ”„ Step 2: aggregateDataByScaleé–¢æ•°ã¯ utils/helpers.js ã«ç§»å‹•æ¸ˆã¿
        
        // ğŸ”„ Step 2: calculateTrendé–¢æ•°ã¯ utils/helpers.js ã«ç§»å‹•æ¸ˆã¿
        
        // ğŸ”„ Step 2: generateInsightsé–¢æ•°ã¯ utils/helpers.js ã«ç§»å‹•æ¸ˆã¿
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³éè¡¨ç¤º
        function hideAllSections() {
            document.getElementById('statisticsSection').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('mlSection').style.display = 'none';
            document.getElementById('insightsSection').style.display = 'none';
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function initTabs() {
            const weightTabBtn = document.getElementById('weightTabBtn');
            const mealTabBtn = document.getElementById('mealTabBtn');
            const exerciseTabBtn = document.getElementById('exerciseTabBtn');
            
            const weightTabContent = document.getElementById('weightTabContent');
            const mealTabContent = document.getElementById('mealTabContent');
            const exerciseTabContent = document.getElementById('exerciseTabContent');
            
            // é£Ÿäº‹ãƒ»é‹å‹•ã‚¿ãƒ–ã®è¦ç´ å–å¾—
            const fetchMealDataBtn = document.getElementById('fetchMealDataBtn');
            const analyzeMealBtn = document.getElementById('analyzeMealBtn');
            const mealDataStatus = document.getElementById('mealDataStatus');
            const fetchExerciseDataBtn = document.getElementById('fetchExerciseDataBtn');
            const analyzeExerciseBtn = document.getElementById('analyzeExerciseBtn');
            const exerciseDataStatus = document.getElementById('exerciseDataStatus');
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            weightTabBtn.addEventListener('click', () => switchTab('weight'));
            mealTabBtn.addEventListener('click', () => switchTab('meal'));
            exerciseTabBtn.addEventListener('click', () => switchTab('exercise'));
            
            function switchTab(tabName) {
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                [weightTabBtn, mealTabBtn, exerciseTabBtn].forEach(btn => {
                    btn.style.background = '';
                    btn.style.color = '';
                });
                
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
                [weightTabContent, mealTabContent, exerciseTabContent].forEach(content => {
                    content.style.display = 'none';
                });
                
                // ä½“é‡ç®¡ç†å›ºæœ‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éš ã™
                const statisticsSection = document.getElementById('statisticsSection');
                const chartsSection = document.getElementById('chartsSection');
                const mlSection = document.getElementById('mlSection');
                const insightsSection = document.getElementById('insightsSection');
                
                if (tabName === 'weight') {
                    weightTabBtn.style.background = '#444';
                    weightTabBtn.style.color = 'white';
                    weightTabContent.style.display = 'block';
                    // ä½“é‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°çµ±è¨ˆãƒ»ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
                    if (weightData && weightData.length > 0) {
                        if (statisticsSection) statisticsSection.style.display = 'block';
                        if (chartsSection) chartsSection.style.display = 'block';
                    }
                } else {
                    // é£Ÿäº‹ãƒ»é‹å‹•ã‚¿ãƒ–ã§ã¯ä½“é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éš ã™
                    if (statisticsSection) statisticsSection.style.display = 'none';
                    if (chartsSection) chartsSection.style.display = 'none';
                    if (mlSection) mlSection.style.display = 'none';
                    if (insightsSection) insightsSection.style.display = 'none';
                    
                    if (tabName === 'meal') {
                        mealTabBtn.style.background = '#444';
                        mealTabBtn.style.color = 'white';
                        mealTabContent.style.display = 'block';
                    } else if (tabName === 'exercise') {
                        exerciseTabBtn.style.background = '#444';
                        exerciseTabBtn.style.color = 'white';
                        exerciseTabContent.style.display = 'block';
                    }
                }
            }
            
            // é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½
            fetchMealDataBtn.addEventListener('click', async () => {
                if (!userData) {
                    mealDataStatus.innerHTML = 'èªè¨¼ãŒå¿…è¦ã§ã™';
                    mealDataStatus.className = 'status error';
                    return;
                }
                
                try {
                    console.log('v0.36-debug: é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userData.uid);
                    mealDataStatus.innerHTML = 'é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
                    mealDataStatus.className = 'status info';
                    
                    const mealRef = database.ref(`users/${userData.uid}/meals`);
                    const snapshot = await mealRef.once('value');
                    
                    if (snapshot.exists()) {
                        const mealData = snapshot.val();
                        mealDataStatus.innerHTML = `${Object.keys(mealData).length}ä»¶ã®é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`;
                        mealDataStatus.className = 'status success';
                        analyzeMealBtn.disabled = false;
                    } else {
                        mealDataStatus.innerHTML = 'é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é£Ÿäº‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';
                        mealDataStatus.className = 'status error';
                        console.log('é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ null: ãƒ‘ã‚¹ users/' + userData.uid + '/meals ã«ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                } catch (error) {
                    console.error('v0.36-debug: é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    mealDataStatus.innerHTML = `é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    mealDataStatus.className = 'status error';
                }
            });
            
            // é‹å‹•ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½
            fetchExerciseDataBtn.addEventListener('click', async () => {
                if (!userData) {
                    exerciseDataStatus.innerHTML = 'èªè¨¼ãŒå¿…è¦ã§ã™';
                    exerciseDataStatus.className = 'status error';
                    return;
                }
                
                try {
                    console.log('v0.36-debug: é‹å‹•ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userData.uid);
                    exerciseDataStatus.innerHTML = 'é‹å‹•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
                    exerciseDataStatus.className = 'status info';
                    
                    const exerciseRef = database.ref(`users/${userData.uid}/exercises`);
                    const snapshot = await exerciseRef.once('value');
                    
                    if (snapshot.exists()) {
                        const exerciseData = snapshot.val();
                        exerciseDataStatus.innerHTML = `${Object.keys(exerciseData).length}ä»¶ã®é‹å‹•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`;
                        exerciseDataStatus.className = 'status success';
                        analyzeExerciseBtn.disabled = false;
                    } else {
                        exerciseDataStatus.innerHTML = 'é‹å‹•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é‹å‹•è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';
                        exerciseDataStatus.className = 'status error';
                        console.log('é‹å‹•ãƒ‡ãƒ¼ã‚¿ null: ãƒ‘ã‚¹ users/' + userData.uid + '/exercises ã«ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                } catch (error) {
                    console.error('v0.36-debug: é‹å‹•ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    exerciseDataStatus.innerHTML = `é‹å‹•ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    exerciseDataStatus.className = 'status error';
                }
            });
            
            // MLåˆ†æãƒœã‚¿ãƒ³ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            analyzeMealBtn.addEventListener('click', () => {
                mealDataStatus.innerHTML = 'é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ã®MLåˆ†ææ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™';
                mealDataStatus.className = 'status success';
            });
            
            analyzeExerciseBtn.addEventListener('click', () => {
                exerciseDataStatus.innerHTML = 'é‹å‹•ãƒ‡ãƒ¼ã‚¿ã®MLåˆ†ææ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™';
                exerciseDataStatus.className = 'status success';
            });
        }
        
        // ğŸ”„ Step 0: æ¤œè¨¼ç”¨é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
        window.validateStep = function(stepNumber) {
            console.log(`âœ… Step ${stepNumber} æ¤œè¨¼é–‹å§‹`);
            
            // 1. ãƒ­ã‚°ç¢ºèª
            const logs = MigrationLog.getLogs(stepNumber);
            console.log('ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ã‚°:', logs);
            
            // 2. æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            console.log('ğŸ” èªè¨¼çŠ¶æ…‹:', firebase.auth().currentUser?.email || 'æœªèªè¨¼');
            console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹:', window.weightData?.length || 0, 'ä»¶');
            
            // 3. UIçŠ¶æ…‹ç¢ºèª
            const activeTab = document.querySelector('[style*="background: #444"]')?.textContent;
            console.log('ğŸ¯ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–:', activeTab || 'ä¸æ˜');
            
            // 4. å…¨ä½“ãƒ­ã‚°ã‚µãƒãƒªãƒ¼
            const allLogs = MigrationLog.getLogs();
            console.log('ğŸ“Š ç·ãƒ­ã‚°æ•°:', allLogs.length);
            
            return {
                step: stepNumber,
                logs: logs,
                status: 'âœ… æ¤œè¨¼å®Œäº†',
                timestamp: new Date().toISOString()
            };
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.loadDemoData = loadDemoData;
        window.MigrationLog = MigrationLog;
        
        // ã‚¿ãƒ–æ©Ÿèƒ½åˆæœŸåŒ–
        initTabs();
        
        console.log('v0.37-Step2: ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† - é–¢æ•°åˆ†é›¢å¯¾å¿œç‰ˆ');
    </script>
</body>
</html>