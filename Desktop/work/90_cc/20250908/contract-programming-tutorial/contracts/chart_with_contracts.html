<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§å®ˆã‚‰ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #chart {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
        }
        .warning {
            color: #ffc107;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <h1>å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ä¿è­·ã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="container">
        <h2>æ­£å¸¸ãªæ“ä½œ</h2>
        <div class="controls">
            <button onclick="chartApp.addValidData()">æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿è¿½åŠ </button>
            <button onclick="chartApp.changeRange('week')">é€±è¡¨ç¤º</button>
            <button onclick="chartApp.changeRange('month')">æœˆè¡¨ç¤º</button>
            <button onclick="chartApp.zoom(1.2)">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</button>
            <button onclick="chartApp.zoom(0.8)">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <h2>å¥‘ç´„é•åã‚’èµ·ã“ã™æ“ä½œï¼ˆAIãŒã‚ˆãã‚„ã‚‹ãƒŸã‚¹ï¼‰</h2>
        <div class="controls">
            <button class="danger" onclick="chartApp.addInvalidData(null)">nullãƒ‡ãƒ¼ã‚¿è¿½åŠ </button>
            <button class="danger" onclick="chartApp.addInvalidData(-50)">è² ã®å€¤è¿½åŠ </button>
            <button class="danger" onclick="chartApp.addInvalidData('æ–‡å­—åˆ—')">æ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿è¿½åŠ </button>
            <button class="danger" onclick="chartApp.changeRange('year')">ç„¡åŠ¹ãªæœŸé–“è¨­å®š</button>
            <button class="danger" onclick="chartApp.zoom(100)">ç•°å¸¸ãªã‚ºãƒ¼ãƒ å€¤</button>
            <button class="danger" onclick="chartApp.breakDataArray()">ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ç ´å£Š</button>
            <button onclick="chartApp.reset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <p><strong>â€»æ³¨æ„</strong>ï¼šã€Œãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ç ´å£Šã€ã‚’æŠ¼ã™ã¨ã€ãã®å¾Œã®ã™ã¹ã¦ã®æ“ä½œãŒå¥‘ç´„é•åã«ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒå¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®é˜²å¾¡åŠ›ã§ã™ï¼</p>
    </div>

    <div class="container">
        <h2>ãƒãƒ£ãƒ¼ãƒˆ</h2>
        <div id="chart">
            <canvas id="chartCanvas"></canvas>
        </div>
        <div id="status"></div>
    </div>

    <div class="container">
        <h2>å¥‘ç´„é•åãƒ­ã‚°</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // å¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        class ContractError extends Error {
            constructor(message, type = 'precondition') {
                super(message);
                this.name = 'ContractError';
                this.type = type;
            }
        }

        function contract(condition, message, type = 'precondition') {
            if (!condition) {
                const error = new ContractError(message, type);
                // ãƒ­ã‚°ã«è¨˜éŒ²
                logContract(error);
                throw error;
            }
        }

        function logContract(error) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'error';
            entry.textContent = `[${timestamp}] ${error.type}é•å: ${error.message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function logSuccess(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'success';
            entry.textContent = `[${timestamp}] æˆåŠŸ: ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ï¼ˆå¥‘ç´„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ä»˜ãï¼‰
        class ChartWithContracts {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.data = [];
                this.range = 'week'; // week, month
                this.zoomLevel = 1.0;
                this.maxDataPoints = 100;
                
                // åˆæœŸãƒ‡ãƒ¼ã‚¿
                this.generateInitialData();
                this._checkInvariant();
                this.draw();
            }

            // ä¸å¤‰æ¡ä»¶
            _checkInvariant() {
                contract(Array.isArray(this.data), 'ãƒ‡ãƒ¼ã‚¿ã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'invariant');
                contract(this.data.length <= this.maxDataPoints, `ãƒ‡ãƒ¼ã‚¿æ•°ã¯${this.maxDataPoints}ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`, 'invariant');
                contract(this.zoomLevel > 0 && this.zoomLevel <= 5, 'ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã¯0-5ã®ç¯„å›²å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'invariant');
                contract(['week', 'month'].includes(this.range), 'è¡¨ç¤ºç¯„å›²ã¯weekã¾ãŸã¯monthã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'invariant');
                
                // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ã„å½¢å¼ã‹
                this.data.forEach((point, index) => {
                    contract(
                        point !== null && typeof point === 'object',
                        `ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ[${index}]ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`,
                        'invariant'
                    );
                    contract(
                        typeof point.value === 'number' && point.value >= 0,
                        `ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ[${index}]ã®å€¤ã¯0ä»¥ä¸Šã®æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`,
                        'invariant'
                    );
                    contract(
                        point.date instanceof Date,
                        `ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ[${index}]ã®æ—¥ä»˜ã¯Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`,
                        'invariant'
                    );
                });
            }

            generateInitialData() {
                const now = new Date();
                for (let i = 30; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    this.data.push({
                        date: date,
                        value: Math.random() * 50 + 50
                    });
                }
            }

            // ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆäº‹å‰æ¡ä»¶ãƒ»äº‹å¾Œæ¡ä»¶ä»˜ãï¼‰
            addData(value, date = new Date()) {
                // äº‹å‰æ¡ä»¶
                contract(typeof value === 'number', `å€¤ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå—ã‘å–ã£ãŸå‹: ${typeof value}ï¼‰`);
                contract(value >= 0, `å€¤ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå—ã‘å–ã£ãŸå€¤: ${value}ï¼‰`);
                contract(value <= 200, `å€¤ã¯200ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå—ã‘å–ã£ãŸå€¤: ${value}ï¼‰`);
                contract(date instanceof Date, 'æ—¥ä»˜ã¯Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                contract(!isNaN(date.getTime()), 'æœ‰åŠ¹ãªæ—¥ä»˜ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');

                const oldLength = this.data.length;
                const oldLastValue = this.data.length > 0 ? this.data[this.data.length - 1].value : null;

                // æœ¬å‡¦ç†
                this.data.push({ value, date });
                
                // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆæœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆï¼‰
                if (this.data.length > this.maxDataPoints) {
                    this.data.shift();
                }

                // äº‹å¾Œæ¡ä»¶
                contract(
                    this.data.length <= this.maxDataPoints,
                    'ãƒ‡ãƒ¼ã‚¿æ•°ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™',
                    'postcondition'
                );
                contract(
                    this.data.length === Math.min(oldLength + 1, this.maxDataPoints),
                    'ãƒ‡ãƒ¼ã‚¿æ•°ãŒæ­£ã—ãå¢—åŠ ã—ã¦ã„ã¾ã›ã‚“',
                    'postcondition'
                );
                contract(
                    this.data[this.data.length - 1].value === value,
                    'è¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å€¤ãŒä¸€è‡´ã—ã¾ã›ã‚“',
                    'postcondition'
                );

                this._checkInvariant();
                this.draw();
                logSuccess(`ãƒ‡ãƒ¼ã‚¿è¿½åŠ : å€¤=${value.toFixed(2)}`);
            }

            // è¡¨ç¤ºç¯„å›²å¤‰æ›´
            changeRange(newRange) {
                // äº‹å‰æ¡ä»¶
                contract(
                    ['week', 'month'].includes(newRange),
                    `ç„¡åŠ¹ãªè¡¨ç¤ºç¯„å›²: ${newRange}ï¼ˆæœ‰åŠ¹ãªå€¤: week, monthï¼‰`
                );

                const oldRange = this.range;

                // æœ¬å‡¦ç†
                this.range = newRange;

                // äº‹å¾Œæ¡ä»¶
                contract(this.range === newRange, 'è¡¨ç¤ºç¯„å›²ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'postcondition');
                
                // åŒã˜ç¯„å›²ã«å¤‰æ›´ã®å ´åˆã¯äº‹å¾Œæ¡ä»¶ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (oldRange !== newRange) {
                    this._checkInvariant();
                    this.draw();
                    logSuccess(`è¡¨ç¤ºç¯„å›²å¤‰æ›´: ${oldRange} â†’ ${newRange}`);
                } else {
                    logSuccess(`è¡¨ç¤ºç¯„å›²ç¶­æŒ: ${newRange}`);
                }
            }

            // ã‚ºãƒ¼ãƒ 
            zoom(factor) {
                // äº‹å‰æ¡ä»¶
                contract(typeof factor === 'number', 'ã‚ºãƒ¼ãƒ å€ç‡ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                contract(factor > 0, 'ã‚ºãƒ¼ãƒ å€ç‡ã¯æ­£ã®æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                contract(factor >= 0.5 && factor <= 2.0, `ã‚ºãƒ¼ãƒ å€ç‡ã¯0.5-2.0ã®ç¯„å›²å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå—ã‘å–ã£ãŸå€¤: ${factor}ï¼‰`);

                const oldZoom = this.zoomLevel;
                const newZoom = this.zoomLevel * factor;

                // çµæœã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                contract(
                    newZoom >= 0.1 && newZoom <= 5.0,
                    `çµæœã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒç¯„å›²å¤–ã§ã™: ${newZoom.toFixed(2)}`
                );

                // æœ¬å‡¦ç†
                this.zoomLevel = newZoom;

                // äº‹å¾Œæ¡ä»¶
                contract(
                    Math.abs(this.zoomLevel - oldZoom * factor) < 0.001,
                    'ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“',
                    'postcondition'
                );

                this._checkInvariant();
                this.draw();
                logSuccess(`ã‚ºãƒ¼ãƒ : ${factor}å€ (æ–°ã—ã„ãƒ¬ãƒ™ãƒ«: ${this.zoomLevel.toFixed(2)})`);
            }

            // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ãï¼‰
            getFilteredData() {
                const now = new Date();
                let startDate = new Date(now);

                if (this.range === 'week') {
                    startDate.setDate(startDate.getDate() - 7);
                } else if (this.range === 'month') {
                    startDate.setDate(startDate.getDate() - 30);
                }

                const filtered = this.data.filter(d => d.date >= startDate);

                // äº‹å¾Œæ¡ä»¶
                contract(Array.isArray(filtered), 'ãƒ•ã‚£ãƒ«ã‚¿çµæœã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'postcondition');
                contract(filtered.length <= this.data.length, 'ãƒ•ã‚£ãƒ«ã‚¿çµæœãŒå…ƒãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šå¤šã„', 'postcondition');

                return filtered;
            }

            // æç”»
            draw() {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;

                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                const padding = 40;

                // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                const data = this.getFilteredData();
                if (data.length === 0) return;

                // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
                const maxValue = Math.max(...data.map(d => d.value)) * 1.1;
                const xScale = (width - padding * 2) / (data.length - 1) * this.zoomLevel;
                const yScale = (height - padding * 2) / maxValue;

                // è»¸ã‚’æç”»
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();

                // ãƒ‡ãƒ¼ã‚¿ã‚’æç”»
                ctx.strokeStyle = '#007bff';
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((point, index) => {
                    const x = padding + index * xScale;
                    const y = height - padding - point.value * yScale;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // ç‚¹ã‚’æç”»
                ctx.fillStyle = '#007bff';
                data.forEach((point, index) => {
                    const x = padding + index * xScale;
                    const y = height - padding - point.value * yScale;

                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                document.getElementById('status').textContent = 
                    `è¡¨ç¤º: ${this.range} | ãƒ‡ãƒ¼ã‚¿æ•°: ${data.length} | ã‚ºãƒ¼ãƒ : ${this.zoomLevel.toFixed(2)}x`;
            }

            // AIãŒã‚ˆãã‚„ã‚‹ãƒŸã‚¹ï¼šãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ç ´å£Š
            breakDataArray() {
                // å¥‘ç´„é•åã‚’èµ·ã“ã™ã‚³ãƒ¼ãƒ‰
                this.data = null; // AIãŒã‚ˆãã‚„ã‚‹ãƒŸã‚¹
                this._checkInvariant(); // ã“ã“ã§å¥‘ç´„é•åï¼
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        const chartApp = {
            chart: null,

            init() {
                this.chart = new ChartWithContracts('chartCanvas');
            },

            addValidData() {
                const value = Math.random() * 50 + 50;
                try {
                    this.chart.addData(value);
                } catch (e) {
                    console.error(e);
                }
            },

            addInvalidData(value) {
                try {
                    this.chart.addData(value);
                } catch (e) {
                    console.error(e);
                }
            },

            changeRange(range) {
                try {
                    this.chart.changeRange(range);
                } catch (e) {
                    console.error(e);
                }
            },

            zoom(factor) {
                try {
                    this.chart.zoom(factor);
                } catch (e) {
                    console.error(e);
                }
            },

            breakDataArray() {
                try {
                    this.chart.breakDataArray();
                } catch (e) {
                    console.error(e);
                }
            },

            reset() {
                try {
                    // ãƒãƒ£ãƒ¼ãƒˆã‚’å†åˆæœŸåŒ–
                    this.chart = new ChartWithContracts('chartCanvas');
                    logSuccess('ãƒãƒ£ãƒ¼ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ');
                } catch (e) {
                    console.error(e);
                }
            }
        };

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            chartApp.init();
        });
    </script>
</body>
</html>